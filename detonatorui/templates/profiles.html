{% extends "base.html" %}

{% block title %}Profiles{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Profiles</h2>
            <div class="space-x-3">
                <button 
                    onclick="resetFormForCreate(); showCreateProfileForm();"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Create Profile
                </button>
                <button 
                    onclick="htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'})"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    Refresh
                </button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-gray-600">
                Profiles define different configurations for malware analysis environments.
            </p>
        </div>
    </div>

    <!-- Create Profile Form (initially hidden) -->
    <div id="create-profile-form" class="bg-white rounded-lg shadow p-6 mb-6" style="display: none;">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Create New Profile</h3>
        <form 
            hx-post="/api/profiles/submit" 
            hx-target="#form-result"
            hx-encoding="application/x-www-form-urlencoded"
            class="space-y-4"
        >
            <input type="hidden" id="profile-id" name="profile_id" value="">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., new_defender"
                    >
                </div>
                
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                    <select 
                        id="type" 
                        name="type" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">Select type...</option>
                        <option value="new">New VM</option>
                        <option value="running">Running VM</option>
                        <option value="clone">Clone VM</option>
                    </select>
                </div>
                
                <div>
                    <label for="edr_collector" class="block text-sm font-medium text-gray-700 mb-1">EDR Collector *</label>
                    <input 
                        type="text" 
                        id="edr_collector" 
                        name="edr_collector" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., defender, crowdstrike"
                    >
                </div>
                
                <div>
                    <label for="port" class="block text-sm font-medium text-gray-700 mb-1">Port *</label>
                    <input 
                        type="number" 
                        id="port" 
                        name="port" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., 8080"
                    >
                </div>
            </div>
            
            <div>
                <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">Comment</label>
                <input 
                    type="text" 
                    id="comment" 
                    name="comment" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Optional description"
                >
            </div>
            
            <div>
                <label for="data" class="block text-sm font-medium text-gray-700 mb-1">Data (JSON) *</label>
                <textarea 
                    id="data" 
                    name="data" 
                    required
                    rows="4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder='{"ip": "192.168.1.100", "admin_username": "admin", "admin_password": "password"}'
                ></textarea>
                <p class="text-sm text-gray-500 mt-1">Enter valid JSON data for the profile configuration</p>
            </div>
            
            <div class="flex space-x-3">
                <button 
                    type="submit"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Create Profile
                </button>
                <button 
                    type="button"
                    onclick="hideCreateProfileForm()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    Cancel
                </button>
            </div>
        </form>
        
        <div id="form-result" class="mt-4"></div>
    </div>

    <!-- Profiles List -->
    <div class="bg-white rounded-lg shadow p-6">
        <div id="profiles-list" 
             hx-get="/templates/profiles" 
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-600">Loading profiles...</p>
            </div>
        </div>
    </div>
</div>

<script>
function showCreateProfileForm() {
    document.getElementById('create-profile-form').style.display = 'block';
}

function hideCreateProfileForm() {
    document.getElementById('create-profile-form').style.display = 'none';
    document.getElementById('form-result').innerHTML = '';
    // Reset form
    document.querySelector('#create-profile-form form').reset();
}

function editProfile(profileName, profileData) {
    // Populate form with existing data
    document.getElementById('name').value = profileName;
    document.getElementById('type').value = profileData.type;
    document.getElementById('edr_collector').value = profileData.edr_collector;
    document.getElementById('port').value = profileData.port;
    document.getElementById('comment').value = profileData.comment || '';
    document.getElementById('data').value = JSON.stringify(profileData.data, null, 2);
    
    // Set the profile ID for updating
    document.getElementById('profile-id').value = profileData.id;
    
    // Change button text and form title
    document.querySelector('#create-profile-form h3').textContent = 'Edit Profile';
    document.querySelector('#create-profile-form button[type="submit"]').textContent = 'Update Profile';
    
    showCreateProfileForm();
}

function editProfileById(button) {
    const profileId = button.getAttribute('data-profile-id');
    const profileName = button.getAttribute('data-profile-name');
    
    console.log('Fetching profile data for ID:', profileId);
    
    // Show loading state
    document.getElementById('form-result').innerHTML = 
        '<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">Loading profile data...</div>';
    
    // Fetch profile data from API
    fetch(`/api/profiles/${profileId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(profileData => {
            console.log('Fetched profile data:', profileData);
            // Clear loading message
            document.getElementById('form-result').innerHTML = '';
            editProfile(profileName, profileData);
        })
        .catch(error => {
            console.error('Error fetching profile data:', error);
            document.getElementById('form-result').innerHTML = 
                '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error loading profile: ' + error.message + '</div>';
        });
}

function deleteProfile(profileId, profileName) {
    if (confirm(`Are you sure you want to delete profile "${profileName}"?`)) {
        fetch(`/api/profiles/${profileId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Show success message briefly
                const tempMsg = document.createElement('div');
                tempMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                tempMsg.textContent = 'Profile deleted successfully!';
                document.body.appendChild(tempMsg);
                
                // Remove message after 2 seconds
                setTimeout(() => {
                    document.body.removeChild(tempMsg);
                }, 2000);
                
                // Refresh the profiles list immediately
                htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'});
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

// Reset form when creating new profile
function resetFormForCreate() {
    const form = document.querySelector('#create-profile-form form');
    
    // Clear the profile ID to indicate this is a new profile
    document.getElementById('profile-id').value = '';
    
    document.querySelector('#create-profile-form h3').textContent = 'Create New Profile';
    document.querySelector('#create-profile-form button[type="submit"]').textContent = 'Create Profile';
    
    form.reset();
    // Reset the profile ID again since form.reset() will clear it
    document.getElementById('profile-id').value = '';
}

// Add JSON validation
function validateJSON() {
    const dataField = document.getElementById('data');
    try {
        JSON.parse(dataField.value);
        dataField.style.borderColor = '';
        return true;
    } catch (e) {
        dataField.style.borderColor = 'red';
        alert('Invalid JSON in data field: ' + e.message);
        return false;
    }
}

// Listen for form completion to refresh profiles list
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.xhr.status === 200 && 
        event.detail.requestConfig.verb === 'post' &&
        event.detail.requestConfig.path.includes('/api/profiles/submit')) {
        // Show success message
        const result = JSON.parse(event.detail.xhr.responseText);
        document.getElementById('form-result').innerHTML = 
            '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">Profile saved successfully!</div>';
        
        // Immediately refresh profiles list and hide form
        htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'});
        
        // Hide form quickly after showing success
        setTimeout(() => {
            hideCreateProfileForm();
            resetFormForCreate();
        }, 500);
    } else if (event.detail.xhr.status >= 400 && 
               event.detail.requestConfig.path.includes('/api/profiles')) {
        // Show error message
        const error = JSON.parse(event.detail.xhr.responseText);
        document.getElementById('form-result').innerHTML = 
            '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error: ' + error.error + '</div>';
    }
});

// Add form validation before submit
document.body.addEventListener('htmx:before', function(event) {
    if (event.detail.requestConfig.path.includes('/api/profiles/submit') && 
        event.detail.requestConfig.verb === 'post') {
        if (!validateJSON()) {
            event.preventDefault();
            return false;
        }
        // Show loading indicator
        document.getElementById('form-result').innerHTML = 
            '<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">Saving profile...</div>';
    }
});

// Add loading indicator for profile fetching
document.body.addEventListener('htmx:beforeRequest', function(event) {
    if (event.detail.requestConfig.path.includes('/templates/profiles')) {
        document.getElementById('profiles-list').innerHTML = 
            '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div><p class="mt-2 text-gray-600">Loading profiles...</p></div>';
    }
});
</script>
{% endblock %}
