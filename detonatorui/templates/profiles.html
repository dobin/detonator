{% extends "base.html" %}

{% block title %}Profiles{% endblock %}

{% block content %}
<div class="mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Profiles</h2>
            <div class="space-x-3">
                <button 
                    data-auth-required
                    onclick="resetFormForCreate(); showCreateProfileForm();"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Create Profile
                </button>
                <button 
                    onclick="htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'})"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    Refresh
                </button>
            </div>
        </div>

        <div class="mb-4">
            <p class="text-gray-600">
                Profiles provide access to EDRs installed on VMs. <br>
                A profile points to a VM with DetonatorAgent or RedEdr, where malware can be detonated. <br>
                After executing, we receive either the detection result, or the detection surface (Events) when using RedEdr.
            </p>
        </div>
    </div>

    <!-- Create Profile Form (initially hidden) -->
    <div id="create-profile-form" class="bg-white rounded-lg shadow p-6 mb-6" style="display: none;">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Create New Profile</h3>
        <form 
            id="profile-form"
            class="space-y-6"
        >
            <input type="hidden" id="profile-id" name="profile_id" value="">
            <input type="hidden" id="mde_json" name="mde" value="">
            
            <!-- Name Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                    <p class="text-sm text-gray-500">Creating a scan will use this to know which VM to use.</p>
                </div>
                <div class="md:col-span-1">
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="defender_live"
                    >
                </div>
            </div>

            <!-- Connector Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="connector" class="block text-sm font-medium text-gray-700 mb-1">Connector *</label>
                    <p class="text-sm text-gray-500">How we connect to the DetonatorAgent/RedEdr on the target VM (and optionally manage the VMs)</p>
                </div>
                <div class="md:col-span-1">
                    <select 
                        id="connector" 
                        name="connector" 
                        required
                        onchange="updateConnectorComment()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">Select connector...</option>
                        <!-- Options will be populated dynamically from connectors API -->
                    </select>
                    <div id="connector-comment" class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700" style="display: none;">
                        <!-- Connector comment will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- EDR Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="edr_collector" class="block text-sm font-medium text-gray-700 mb-1">EDR</label>
                    <p class="text-sm text-gray-500">
                        Optional. The EDR system running on the target VM. Freetext. <br>
                        Use magic "RedEdr" when only collecting events from RedEdr, when caring about detection result.
                    </p>
                </div>
                <div class="md:col-span-1">
                    <input 
                        type="text" 
                        id="edr_collector" 
                        name="edr_collector" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="RedEdr or freetext: MDE / DefenderEndpoint / ..."
                    >
                </div>
            </div>

            <!-- Default Malware Path Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="default_drop_path" class="block text-sm font-medium text-gray-700 mb-1">Default Malware Path</label>
                    <p class="text-sm text-gray-500">
                        Optional. Default directory where malware will be uploaded. Can be overwritten by scan. <br>
                        Default is <code>C:\Users\Public\Downloads\</code>. <br>
                        Note: Use whitelisted <code>C:\RedEdr\data\</code> for no EDR detection.
                    </p>
                </div>
                <div class="md:col-span-1">
                    <input 
                        type="text" 
                        id="default_drop_path" 
                        name="default_drop_path" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="C:\Users\Public\Downloads"
                    >
                </div>
            </div>

            <!-- Port Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="port" class="block text-sm font-medium text-gray-700 mb-1">Port *</label>
                    <p class="text-sm text-gray-500">Port number of the DetonatorAgent/RedEdr on the target VM.</p>
                </div>
                <div class="md:col-span-1">
                    <input 
                        type="number" 
                        id="port" 
                        name="port" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="8000"
                    >
                </div>
            </div>

            <!-- RedEdr Port Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="rededr_port" class="block text-sm font-medium text-gray-700 mb-1">RedEdr Port</label>
                    <p class="text-sm text-gray-500">Port number for RedEdr API (optional, if different from main port).</p>
                </div>
                <div class="md:col-span-1">
                    <input 
                        type="number" 
                        id="rededr_port" 
                        name="rededr_port" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder=""
                    >
                </div>
            </div>

            <!-- Comment Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">Comment</label>
                    <p class="text-sm text-gray-500">Optional description or notes about this profile</p>
                </div>
                <div class="md:col-span-1">
                    <input 
                        type="text" 
                        id="comment" 
                        name="comment" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Optional description"
                    >
                </div>
            </div>

            <!-- Data Field -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div class="md:col-span-1">
                    <label for="data" class="block text-sm font-medium text-gray-700 mb-1">Data (JSON) *</label>
                    <p class="text-sm text-gray-500">Configuration data in JSON format. Sample data will be auto-filled when you select a connector.</p>
                </div>
                <div class="md:col-span-1">
                    <textarea 
                        id="data" 
                        name="data" 
                        required
                        rows="4"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder='{"ip": "192.168.1.100", "admin_username": "admin", "admin_password": "password"}'
                    ></textarea>
                </div>
            </div>
            <div class="flex space-x-3">
                <button 
                    data-auth-required
                    type="submit"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Create Profile
                </button>
                <button 
                    type="button"
                    onclick="hideCreateProfileForm()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    Cancel
                </button>
            </div>
        </form>
        
        <div id="form-result" class="mt-4"></div>
    </div>

    <!-- Profiles List -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Active Profiles</h3>
            <div id="loading-indicator" class="htmx-indicator">
                <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                <span class="ml-2 text-sm text-gray-600">Refreshing...</span>
            </div>
        </div>
        <div id="profiles-list" 
             hx-get="/templates/profiles" 
             hx-trigger="load, every 10s"
             hx-swap="innerHTML swap:300ms"
             hx-indicator="#loading-indicator">
            <div class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-600">Loading profiles...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Global variable to store connector data
let connectorsData = {};

// Add CSS for loading indicator
const style = document.createElement('style');
style.textContent = `
    .htmx-indicator {
        opacity: 0;
        transition: opacity 200ms ease-in;
    }
    .htmx-request .htmx-indicator {
        opacity: 1;
    }
    .htmx-request.htmx-indicator {
        opacity: 1;
    }
`;
document.head.appendChild(style);

// Load available connectors dynamically
function loadConnectors() {
    return fetch('{{ API_BASE_URL }}/api/connectors')
        .then(response => response.json())
        .then(connectors => {
            // Store connector data globally for later use
            connectorsData = connectors;
            
            const connectorSelect = document.getElementById('connector');
            // Clear existing options except the first one
            while (connectorSelect.children.length > 1) {
                connectorSelect.removeChild(connectorSelect.lastChild);
            }
            
            // Add connector options
            Object.keys(connectors).forEach(connectorKey => {
                const connector = connectors[connectorKey];
                const option = document.createElement('option');
                option.value = connectorKey;
                option.textContent = `${connectorKey} - ${connector.description}`;
                option.title = connector.comment; // Show comment as tooltip
                connectorSelect.appendChild(option);
            });
            
            return connectors; // Return the connectors data
        })
        .catch(error => {
            console.error('Error loading connectors:', error);
            // Fallback to basic options if API fails
            const connectorSelect = document.getElementById('connector');
            ['NewAzure', 'Live'].forEach(connector => {
                const option = document.createElement('option');
                option.value = connector;
                option.textContent = connector;
                connectorSelect.appendChild(option);
            });
            
            // Return empty object for fallback
            return {};
        });
}

// Update connector comment display when selection changes
function updateConnectorComment(autoFillData = true) {
    const connectorSelect = document.getElementById('connector');
    const commentDiv = document.getElementById('connector-comment');
    const dataField = document.getElementById('data');
    const selectedConnector = connectorSelect.value;
    
    if (selectedConnector && connectorsData[selectedConnector]) {
        const connector = connectorsData[selectedConnector];
        const comment = connector.comment;
        const sampleData = connector.sample_data;
        
        // Update comment display
        if (comment && comment.trim() !== '') {
            commentDiv.innerHTML = `${comment}`;
            commentDiv.style.display = 'block';
        } else {
            commentDiv.style.display = 'none';
        }
        
        // Update data field with sample data only if autoFillData is true
        if (autoFillData && sampleData && Object.keys(sampleData).length > 0) {
            dataField.value = JSON.stringify(sampleData, null, 2);
            
            // Brief visual feedback that the field was auto-filled
            const originalBorderColor = dataField.style.borderColor;
            dataField.style.borderColor = '#10B981'; // green
            dataField.style.transition = 'border-color 0.3s ease';
            setTimeout(() => {
                dataField.style.borderColor = originalBorderColor;
            }, 1000);
        }
    } else {
        commentDiv.style.display = 'none';
    }
}

// Load connectors when page loads
document.addEventListener('DOMContentLoaded', loadConnectors);

function showCreateProfileForm() {
    document.getElementById('create-profile-form').style.display = 'block';
    // Only load connectors if they haven't been loaded yet
    if (Object.keys(connectorsData).length === 0) {
        loadConnectors();
    }
}

function hideCreateProfileForm() {
    document.getElementById('create-profile-form').style.display = 'none';
    document.getElementById('form-result').innerHTML = '';
    // Hide connector comment
    document.getElementById('connector-comment').style.display = 'none';
    // Reset form
    document.querySelector('#create-profile-form form').reset();
}

function editProfile(profileName, profileData) {
    // Show form first
    showCreateProfileForm();
    
    // Change button text and form title
    document.querySelector('#create-profile-form h3').textContent = 'Edit Profile';
    document.querySelector('#create-profile-form button[type="submit"]').textContent = 'Update Profile';
    
    // Load connectors first, then populate form data
    loadConnectors().then(() => {
        // Populate form with existing data after connectors are loaded
        document.getElementById('name').value = profileName;
        document.getElementById('connector').value = profileData.connector;
        document.getElementById('edr_collector').value = profileData.edr_collector;
        document.getElementById('default_drop_path').value = profileData.default_drop_path || '';
        document.getElementById('port').value = profileData.port;
        document.getElementById('rededr_port').value = profileData.rededr_port || '';
        document.getElementById('comment').value = profileData.comment || '';
        document.getElementById('data').value = JSON.stringify(profileData.data, null, 2);
        
        // Set the profile ID for updating
        document.getElementById('profile-id').value = profileData.id;
        
        // Update connector comment display after form is populated
        updateConnectorComment(false);
    }).catch(error => {
        console.error('Error loading connectors for edit:', error);
        // Fallback: populate form anyway
        document.getElementById('name').value = profileName;
        document.getElementById('connector').value = profileData.connector;
        document.getElementById('edr_collector').value = profileData.edr_collector;
        document.getElementById('default_drop_path').value = profileData.default_drop_path || '';
        document.getElementById('port').value = profileData.port;
        document.getElementById('rededr_port').value = profileData.rededr_port || '';
        document.getElementById('comment').value = profileData.comment || '';
        document.getElementById('data').value = JSON.stringify(profileData.data, null, 2);
        document.getElementById('profile-id').value = profileData.id;
    });
}

function editProfileById(profileId, profileName) {
    console.log('Fetching profile data for ID:', profileId);
    
    // Show loading state
    document.getElementById('form-result').innerHTML = 
        '<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">Loading profile data...</div>';
    
    // Fetch profile data from API
    fetch(`{{ API_BASE_URL }}/api/profiles/${profileId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(profileData => {
            console.log('Fetched profile data:', profileData);
            // Clear loading message
            document.getElementById('form-result').innerHTML = '';
            editProfile(profileName, profileData);
        })
        .catch(error => {
            console.error('Error fetching profile data:', error);
            document.getElementById('form-result').innerHTML = 
                '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error loading profile: ' + error.message + '</div>';
        });
}

function deleteProfile(profileId, profileName) {
    if (confirm(`Are you sure you want to delete profile "${profileName}"?`)) {
        fetch(`{{ API_BASE_URL }}/api/profiles/${profileId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Show success message briefly
                const tempMsg = document.createElement('div');
                tempMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                tempMsg.textContent = 'Profile deleted successfully!';
                document.body.appendChild(tempMsg);
                
                // Remove message after 2 seconds
                setTimeout(() => {
                    document.body.removeChild(tempMsg);
                }, 2000);
                
                // Refresh the profiles list immediately
                htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'});
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function releaseLock(profileId, profileName) {
    if (confirm(`Are you sure you want to release the lock for profile "${profileName}"?`)) {
        fetch(`{{ API_BASE_URL }}/api/profiles/${profileId}/release_lock`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Show success message briefly
                const tempMsg = document.createElement('div');
                tempMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                tempMsg.textContent = data.message || 'Lock released successfully!';
                document.body.appendChild(tempMsg);
                
                // Remove message after 2 seconds
                setTimeout(() => {
                    document.body.removeChild(tempMsg);
                }, 2000);
                
                // Refresh the profiles list immediately to update status
                htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'});
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function rebootProfile(profileId, profileName) {
    if (confirm(`Are you sure you want to reboot the VM for profile "${profileName}"?`)) {
        fetch(`{{ API_BASE_URL }}/api/profiles/${profileId}/reboot`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error || data.detail) {
                alert('Error: ' + (data.error || data.detail));
            } else {
                // Show success message briefly
                const tempMsg = document.createElement('div');
                tempMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                tempMsg.textContent = data.message || 'VM reboot initiated!';
                document.body.appendChild(tempMsg);
                
                // Remove message after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(tempMsg);
                }, 3000);
                
                // Refresh the profiles list after a delay to show updated status
                setTimeout(() => {
                    htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'});
                }, 1000);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function revertProfile(profileId, profileName) {
    if (confirm(`Are you sure you want to revert the VM to snapshot for profile "${profileName}"?\n\nThis will:\n1. Stop the VM\n2. Revert to the configured snapshot\n3. Start the VM again`)) {
        // Show processing message
        const processingMsg = document.createElement('div');
        processingMsg.id = 'revert-processing-msg';
        processingMsg.className = 'fixed top-4 right-4 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded z-50';
        processingMsg.innerHTML = '<div class="flex items-center"><div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>Reverting VM... This may take a minute.</div>';
        document.body.appendChild(processingMsg);
        
        fetch(`{{ API_BASE_URL }}/api/profiles/${profileId}/revert`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            // Remove processing message
            const msg = document.getElementById('revert-processing-msg');
            if (msg) document.body.removeChild(msg);
            
            if (data.error || data.detail) {
                alert('Error: ' + (data.error || data.detail));
            } else {
                // Show success message
                const tempMsg = document.createElement('div');
                tempMsg.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                tempMsg.textContent = data.message || 'VM reverted and restarted successfully!';
                document.body.appendChild(tempMsg);
                
                // Remove message after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(tempMsg);
                }, 3000);
                
                // Refresh the profiles list
                htmx.ajax('GET', '/templates/profiles', {target: '#profiles-list', swap: 'innerHTML'});
            }
        })
        .catch(error => {
            // Remove processing message
            const msg = document.getElementById('revert-processing-msg');
            if (msg) document.body.removeChild(msg);
            
            alert('Error: ' + error);
        });
    }
}

// Reset form when creating new profile
function resetFormForCreate() {
    const form = document.querySelector('#create-profile-form form');
    
    // Clear the profile ID to indicate this is a new profile
    document.getElementById('profile-id').value = '';
    
    document.querySelector('#create-profile-form h3').textContent = 'Create New Profile';
    document.querySelector('#create-profile-form button[type="submit"]').textContent = 'Create Profile';
    
    form.reset();
    // Reset the profile ID again since form.reset() will clear it
    document.getElementById('profile-id').value = '';
    
    // Ensure connectors are loaded for new profiles
    if (Object.keys(connectorsData).length === 0) {
        loadConnectors();
    }
}

// Add JSON validation
function validateJSON() {
    const dataField = document.getElementById('data');
    try {
        JSON.parse(dataField.value);
        dataField.style.borderColor = '';
        return true;
    } catch (e) {
        dataField.style.borderColor = 'red';
        alert('Invalid JSON in data field: ' + e.message);
        return false;
    }
}

// Handle form submission with fetch to the API
document.getElementById('profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!validateJSON()) {
        return;
    }

    const resultBox = document.getElementById('form-result');
    resultBox.innerHTML = '<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">Saving profile...</div>';

    const profileId = document.getElementById('profile-id').value;
    const url = profileId
        ? `{{ API_BASE_URL }}/api/profiles/${profileId}`
        : '{{ API_BASE_URL }}/api/profiles';
    const method = profileId ? 'PUT' : 'POST';

    const formData = new FormData(e.target);
    formData.delete('profile_id');
    const body = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
        if (key === 'rededr_port' && (!value || value.trim() === '')) {
            continue;
        }
        body.append(key, value ?? '');
    }

    try {
        const response = await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: body.toString(),
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(payload.detail || payload.error || `Server returned status ${response.status}`);
        }

        resultBox.innerHTML =
            '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">Profile saved successfully!</div>';

        htmx.ajax('GET', '/templates/profiles', { target: '#profiles-list', swap: 'innerHTML' });

        setTimeout(() => {
            hideCreateProfileForm();
            resetFormForCreate();
            resultBox.innerHTML = '';
        }, 600);
    } catch (error) {
        resultBox.innerHTML =
            '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error: ' +
            error.message +
            '</div>';
    }
});

</script>
{% endblock %}
