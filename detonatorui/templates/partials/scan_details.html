{% if scan %}
<div class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div><strong>Scan ID:</strong> {{ scan.id }}</div>
        <div><strong>File ID:</strong> {{ scan.file_id }}</div>
        {% if scan.file and scan.file.comment %}
        <div><strong>File Comment:</strong> {{ scan.file.comment }}</div>
        {% endif %}
        {% if scan.comment %}
        <div><strong>Scan Comment:</strong> {{ scan.comment }}</div>
        {% endif %}
        <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs {{ get_status_color(scan.status) }}">{{ scan.status }}</span></div>
        <div><strong>Project:</strong> {{ scan.project or '' }}</div>
        <div><strong>Profile:</strong> {{ scan.profile.name if scan.profile else '' }}</div>
        <div><strong>VM Instance:</strong> {{ scan.vm_instance_name or '' }}</div>
        <div><strong>VM IP:</strong> {{ scan.vm_ip_address or '' }}</div>
        <div><strong>Result:</strong> {{ scan.result or '' }}</div>
        {% if scan.profile and scan.profile.data.get('device_info') %}
            {% set device_info = scan.profile.data.get('device_info', {}) %}
            {% if device_info.get('hostname') %}
            <div><strong>Agent Hostname:</strong> {{ device_info.get('hostname') }}</div>
            {% endif %}
            {% if device_info.get('os_version') %}
            <div><strong>Agent OS:</strong> {{ device_info.get('os_version') }}</div>
            {% endif %}
            {% if device_info.get('device_id') %}
            <div><strong>Device ID (Sense):</strong> <span class="font-mono text-xs break-all">{{ device_info.get('device_id') }}</span></div>
            {% endif %}
        {% endif %}
    </div>
    
    <!-- Logs Tabs -->
    {% if scan.detonator_srv_logs or log or scan.edr_summary %}
    <div class="w-full">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                {% if scan.detonator_srv_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600" 
                    data-tab="detonator-logs" onclick="showTab('detonator-logs', this)"
                >
                    Detonator Server Logs
                </button>
                {% endif %}

                {% if scan.agent_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="agent-logs" onclick="showTab('agent-logs', this)"
                >
                    Agent Logs
                </button>
                {% endif %}

                {% if scan.execution_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="execution-logs" onclick="showTab('execution-logs', this)"
                >
                    Execution Logs
                </button>
                {% endif %}

                {% if scan.edr_summary %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="edr-summary" onclick="showTab('edr-summary', this)"
                >
                    EDR Summary
                </button>
                {% endif %}

                {% if scan.edr_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="edr-logs" onclick="showTab('edr-logs', this)"
                >
                    EDR Raw
                </button>
                {% endif %}

                {% if scan.rededr_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="rededr-logs" onclick="showTab('rededr-logs', this)"
                >
                    RedEdr Logs
                </button>
                {% endif %}
                {% if scan.profile and scan.profile.data.get('edr_mde') %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="mde-alerts" onclick="showTab('mde-alerts', this)"
                >
                    MDE Alerts
                </button>
                {% endif %}
            </nav>
        </div>
        
        <div class="mt-4">
            {% if scan.detonator_srv_logs %}
            <div id="detonator-logs" class="tab-content">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.detonator_srv_logs }}</pre>
            </div>
            {% endif %}

            {% if scan.agent_logs %}
            <div id="agent-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.agent_logs|pretty_json }}
                </pre>
            </div>
            {% endif %}
            
            {% if scan.execution_logs %}
            <div id="execution-logs" class="tab-content hidden">
                {% if scan.execution_logs is mapping %}
                <div class="space-y-3">
                    {% if scan.execution_logs.pid %}
                    <div>
                        <div class="text-xs font-semibold text-gray-600 mb-1">PID: (if available)</div>
                        <div class="bg-gray-100 p-2 rounded text-sm">{{ scan.execution_logs.pid }}</div>
                    </div>
                    {% endif %}
                    
                    {% if scan.execution_logs.stdout %}
                    <div>
                        <div class="text-xs font-semibold text-gray-600 mb-1">STDOUT: (gathered on process exit)</div>
                        <pre class="bg-gray-100 p-2 rounded text-sm max-h-60 overflow-y-auto w-full">{{ scan.execution_logs.stdout }}</pre>
                    </div>
                    {% endif %}
                    
                    {% if scan.execution_logs.stderr %}
                    <div>
                        <div class="text-xs font-semibold text-gray-600 mb-1">STDERR:</div>
                        <pre class="bg-red-50 p-2 rounded text-sm max-h-60 overflow-y-auto w-full text-red-800">{{ scan.execution_logs.stderr }}</pre>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.execution_logs|pretty_json }}
                </pre>
                {% endif %}
            </div>
            {% endif %}
            
            {% if scan.edr_summary %}
            <div id="edr-summary" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.edr_summary }}</pre>
            </div>
            {% endif %}

            {% if scan.edr_logs %}
            <div id="edr-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full whitespace-pre-wrap" data-scroll-bottom
                    >{{ scan.edr_logs|pretty_json }}</pre>
            </div>
            {% endif %}

            {% if scan.rededr_logs %}
            <div id="rededr-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full whitespace-pre-wrap" data-scroll-bottom
                    >{{ scan.rededr_logs|pretty_json }}</pre>
            </div>
            {% endif %}
            {% if scan.profile and scan.profile.data.get('edr_mde') %}
            <div id="mde-alerts" class="tab-content hidden">
                {% if scan.alerts %}
                <div class="space-y-4">
                    {% for alert in scan.alerts %}
                    <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-sm space-y-3">
                        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                            <div>
                                <div class="text-xs uppercase tracking-wide text-gray-500">Alert</div>
                                <div class="text-base font-semibold text-gray-900">
                                    {{ alert.title or 'Defender Alert' }}
                                </div>
                                <div class="text-sm text-gray-600">
                                    {{ alert.category or 'Uncategorized' }}
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 md:text-right">
                                <div><strong>Detected:</strong> {{ alert.detected_at|strftime('%Y-%m-%d %H:%M:%S') if alert.detected_at else 'Pending' }}</div>
                                <div><strong>Severity:</strong> {{ alert.severity or 'N/A' }}</div>
                                <div><strong>Source:</strong> {{ alert.detection_source or 'Unknown' }}</div>
                                <div><strong>ID:</strong> <span class="font-mono text-xs break-all">{{ alert.alert_id }}</span></div>
                            </div>
                        </div>

                        {% set evidence = [] %}
                        {% if alert.raw_alert and alert.raw_alert.get('evidence') %}
                            {% set evidence = alert.raw_alert.get('evidence') %}
                        {% endif %}

                        {% if evidence %}
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Timestamp</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Role</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Entity</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-700">Details</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {% for ev in evidence %}
                                    <tr class="align-top">
                                        <td class="px-3 py-2 whitespace-nowrap">
                                            {{ ev.Timestamp or 'N/A' }}
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap">{{ ev.EvidenceRole or 'Unknown' }}</td>
                                        <td class="px-3 py-2 whitespace-nowrap">{{ ev.EntityType or 'Unknown' }}</td>
                                        <td class="px-3 py-2 space-y-1">
                                            {% set meta = namespace(shown=False) %}
                                            {% if ev.DeviceName or ev.DeviceId %}
                                                <div><span class="font-medium text-gray-700">Device:</span> {{ ev.DeviceName or ev.DeviceId }}</div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if ev.FileName %}
                                                {% set file_hash = ev.FileSha256 or ev.FileSHA256 or ev.SHA256 or ev.Sha256 %}
                                                <div>
                                                    <span class="font-medium text-gray-700">File:</span>
                                                    {{ ev.FileName }}{% if file_hash %} <span class="text-xs text-gray-500">({{ file_hash }})</span>{% endif %}
                                                </div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if ev.ProcessCommandLine %}
                                                <div>
                                                    <span class="font-medium text-gray-700">Command:</span>
                                                    <span class="font-mono text-xs break-all">{{ ev.ProcessCommandLine }}</span>
                                                </div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if ev.AccountName %}
                                                <div>
                                                    <span class="font-medium text-gray-700">Account:</span>
                                                    {{ ev.AccountDomain ~ '\\' if ev.AccountDomain else '' }}{{ ev.AccountName }}
                                                </div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if ev.RemoteUrl or ev.RemoteIP %}
                                                <div>
                                                    <span class="font-medium text-gray-700">Remote:</span>
                                                    {{ ev.RemoteUrl or ev.RemoteIP }}
                                                    {% if ev.RemotePort %}:{{ ev.RemotePort }}{% endif %}
                                                </div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if ev.RegistryKey or ev.RegistryValueName %}
                                                <div>
                                                    <span class="font-medium text-gray-700">Registry:</span>
                                                    {{ ev.RegistryKey }}{% if ev.RegistryValueName %} ({{ ev.RegistryValueName }}){% endif %}
                                                </div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if ev.FolderPath %}
                                                <div>
                                                    <span class="font-medium text-gray-700">Path:</span>
                                                    {{ ev.FolderPath }}
                                                </div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if ev.ThreatFamilyName %}
                                                <div>
                                                    <span class="font-medium text-gray-700">Threat:</span>
                                                    {{ ev.ThreatFamilyName }}
                                                </div>
                                                {% set meta.shown = True %}
                                            {% endif %}
                                            {% if not meta.shown %}
                                                <div class="text-gray-500">No additional attributes reported.</div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="bg-gray-50 border border-dashed border-gray-300 rounded p-3 text-sm text-gray-600">
                            No detailed evidence has been returned for this alert yet.
                        </div>
                        {% endif %}

                        {% if alert.raw_alert and alert.raw_alert.get('evidence_refreshed_at') %}
                        <div class="text-xs text-gray-500">
                            Evidence refreshed: {{ alert.raw_alert.get('evidence_refreshed_at')|strftime('%Y-%m-%d %H:%M:%S') }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="bg-gray-50 border border-gray-200 rounded p-4 text-sm text-gray-600">
                    <p>No Defender alerts collected yet.</p>
                    <p class="mt-2">
                        Detonator polls Microsoft Defender for some minutes after execution completes.
                        If detections occur during that window they will appear here automatically.
                    </p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        function showTab(tabId, clickedButton) {
            // Hide all tab contents
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active styles from all buttons
            const allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show target tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // Style active button
            clickedButton.classList.remove('border-transparent', 'text-gray-500');
            clickedButton.classList.add('border-blue-500', 'text-blue-600');
        }
    </script>
    {% endif %}
    
    <div class="text-sm text-gray-500">
        <p>Created: {{ scan.created_at|strftime('%Y-%m-%d %H:%M:%S') }}</p>
        <p>Updated: {{ scan.updated_at|strftime('%Y-%m-%d %H:%M:%S') }}</p>
        {% if scan.completed_at %}
        <p>Completed: {{ scan.completed_at|strftime('%Y-%m-%d %H:%M:%S') }}</p>
        {% endif %}
    </div>
</div>

{% else %}
<div class="text-center text-red-500">
    <p>Error: Could not load scan details.</p>
</div>
{% endif %}
