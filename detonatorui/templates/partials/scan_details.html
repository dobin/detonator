{% if scan %}
<div class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div><strong>Scan ID:</strong> {{ scan.id }}</div>
        <div><strong>File ID:</strong> {{ scan.file_id }}</div>
        {% if scan.file and scan.file.comment %}
        <div><strong>File Comment:</strong> {{ scan.file.comment }}</div>
        {% endif %}
        {% if scan.comment %}
        <div><strong>Scan Comment:</strong> {{ scan.comment }}</div>
        {% endif %}
        <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs {{ get_status_color(scan.status) }}">{{ scan.status }}</span></div>
        <div><strong>Project:</strong> {{ scan.project or '' }}</div>
        <div><strong>Profile:</strong> {{ scan.profile.name if scan.profile else '' }}</div>
        <div><strong>VM Instance:</strong> {{ scan.vm_instance_name or '' }}</div>
        <div><strong>VM IP:</strong> {{ scan.vm_ip_address or '' }}</div>
        <div><strong>Result:</strong> {{ scan.result or '' }}</div>
        {% if scan.detection_window_minutes is not none %}
        <div><strong>Detection Window:</strong> {{ scan.detection_window_minutes }} min</div>
        {% endif %}
        {% if scan.device_hostname %}
        <div><strong>Agent Hostname:</strong> {{ scan.device_hostname }}</div>
        {% endif %}
        {% if scan.device_os_version %}
        <div><strong>Agent OS:</strong> {{ scan.device_os_version }}</div>
        {% endif %}
        {% if scan.device_id %}
        <div><strong>Device ID (Sense):</strong> <span class="font-mono text-xs break-all">{{ scan.device_id }}</span></div>
        {% endif %}
    </div>
    
    <!-- Logs Tabs -->
    {% if scan.detonator_srv_logs or log or scan.edr_summary %}
    <div class="w-full">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                {% if scan.detonator_srv_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600" 
                    data-tab="detonator-logs" onclick="showTab('detonator-logs', this)"
                >
                    Detonator Server Logs
                </button>
                {% endif %}

                {% if scan.agent_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="agent-logs" onclick="showTab('agent-logs', this)"
                >
                    Agent Logs
                </button>
                {% endif %}

                {% if scan.execution_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="execution-logs" onclick="showTab('execution-logs', this)"
                >
                    Execution Logs
                </button>
                {% endif %}

                {% if scan.edr_summary %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="edr-summary" onclick="showTab('edr-summary', this)"
                >
                    EDR Summary
                </button>
                {% endif %}

                {% if scan.edr_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="edr-logs" onclick="showTab('edr-logs', this)"
                >
                    EDR Raw
                </button>
                {% endif %}

                {% if scan.rededr_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="rededr-logs" onclick="showTab('rededr-logs', this)"
                >
                    RedEdr Logs
                </button>
                {% endif %}
                {% if scan.profile and scan.profile.mde %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="mde-alerts" onclick="showTab('mde-alerts', this)"
                >
                    MDE Alerts
                </button>
                {% endif %}
            </nav>
        </div>
        
        <div class="mt-4">
            {% if scan.detonator_srv_logs %}
            <div id="detonator-logs" class="tab-content">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.detonator_srv_logs }}</pre>
            </div>
            {% endif %}

            {% if scan.agent_logs %}
            <div id="agent-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.agent_logs|pretty_json }}
                </pre>
            </div>
            {% endif %}
            
            {% if scan.execution_logs %}
            <div id="execution-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.execution_logs|pretty_json }}
                </pre>
            </div>
            {% endif %}
            
            {% if scan.edr_summary %}
            <div id="edr-summary" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ scan.edr_summary }}</pre>
            </div>
            {% endif %}

            {% if scan.edr_logs %}
            <div id="edr-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full whitespace-pre-wrap" data-scroll-bottom
                    >{{ scan.edr_logs|pretty_json }}</pre>
            </div>
            {% endif %}

            {% if scan.rededr_logs %}
            <div id="rededr-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full whitespace-pre-wrap" data-scroll-bottom
                    >{{ scan.rededr_logs|pretty_json }}</pre>
            </div>
            {% endif %}
            {% if scan.profile and scan.profile.mde %}
            <div id="mde-alerts" class="tab-content hidden">
                {% if scan.alerts %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium text-gray-700">Timestamp</th>
                                <th class="px-3 py-2 text-left font-medium text-gray-700">Title</th>
                                <th class="px-3 py-2 text-left font-medium text-gray-700">Severity</th>
                                <th class="px-3 py-2 text-left font-medium text-gray-700">Categories</th>
                                <th class="px-3 py-2 text-left font-medium text-gray-700">Detection Source</th>
                                <th class="px-3 py-2 text-left font-medium text-gray-700">Alert ID</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for alert in scan.alerts %}
                            <tr>
                                <td class="px-3 py-2">
                                    {{ alert.detected_at|strftime('%Y-%m-%d %H:%M:%S') if alert.detected_at else 'N/A' }}
                                </td>
                                <td class="px-3 py-2">
                                    <div class="font-medium">{{ alert.title or 'Unnamed alert' }}</div>
                                </td>
                                <td class="px-3 py-2">{{ alert.severity or 'N/A' }}</td>
                                <td class="px-3 py-2">
                                    {% if alert.category %}
                                        {{ alert.category }}
                                    {% elif alert.raw_alert and alert.raw_alert.Categories %}
                                        {{ alert.raw_alert.Categories }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2">{{ alert.detection_source or 'Unknown' }}</td>
                                <td class="px-3 py-2 break-all">{{ alert.alert_id }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="bg-gray-50 border border-gray-200 rounded p-4 text-sm text-gray-600">
                    <p>No Defender alerts collected yet.</p>
                    <p class="mt-2">
                        Detonator polls Microsoft Defender for {{ scan.detection_window_minutes or 1 }} minute{{ '' if (scan.detection_window_minutes or 1) == 1 else 's' }} after execution completes.
                        If detections occur during that window they will appear here automatically.
                    </p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        function showTab(tabId, clickedButton) {
            // Hide all tab contents
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active styles from all buttons
            const allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show target tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // Style active button
            clickedButton.classList.remove('border-transparent', 'text-gray-500');
            clickedButton.classList.add('border-blue-500', 'text-blue-600');
        }
    </script>
    {% endif %}
    
    <div class="text-sm text-gray-500">
        <p>Created: {{ scan.created_at|strftime('%Y-%m-%d %H:%M:%S') }}</p>
        <p>Updated: {{ scan.updated_at|strftime('%Y-%m-%d %H:%M:%S') }}</p>
        {% if scan.completed_at %}
        <p>Completed: {{ scan.completed_at|strftime('%Y-%m-%d %H:%M:%S') }}</p>
        {% endif %}
    </div>
</div>

{% else %}
<div class="text-center text-red-500">
    <p>Error: Could not load scan details.</p>
</div>
{% endif %}
