{% if submission %}
<div class="space-y-4">
    <table class="min-w-full text-sm border border-gray-200">
        <tbody class="bg-white">
            <tr>
                <td class="px-3 py-2 font-semibold text-gray-700 w-1/4">Submission ID:</td>
                <td class="px-3 py-2 border-r border-gray-200">{{ submission.id }}</td>

                <td class="px-3 py-2 font-semibold text-gray-700">File ID:</td>
                <td class="px-3 py-2 border-r border-gray-200">{{ submission.file_id }}</td>

                <td class="px-3 py-2 font-semibold text-gray-700">Created:</td>
                <td class="px-3 py-2 text-gray-500">{{ submission.created_at|strftime('%Y-%m-%d %H:%M:%S') }}</td>
            </tr>

            <tr>
                <td class="px-3 py-2 font-semibold text-gray-700">Submission Comment:</td>
                <td class="px-3 py-2 border-r border-gray-200">{{ submission.comment }}</td>

                <td class="px-3 py-2 font-semibold text-gray-700">File Comment:</td>
                <td class="px-3 py-2 border-r border-gray-200">{{ submission.file.comment }}</td>

                <td class="px-3 py-2 font-semibold text-gray-700">Updated:</td>
                <td class="px-3 py-2 text-gray-500">{{ submission.updated_at|strftime('%Y-%m-%d %H:%M:%S') }}</td>
            </tr>

            <tr>
                <td class="px-3 py-2 font-semibold text-gray-700">Submission Status:</td>
                <td class="px-3 py-2 border-r border-gray-200"><span class="px-2 py-1 rounded text-xs {{ get_status_color(submission.status) }}">{{ submission.status }}</span></td>

                <td class="px-3 py-2 font-semibold text-gray-700">Profile:</td>
                <td class="px-3 py-2">{{ submission.profile.name if submission.profile else '' }}</td>

                <td class="px-3 py-2 font-semibold text-gray-700">Completed:</td>
                <td class="px-3 py-2 text-gray-500">{{ submission.completed_at|strftime('%Y-%m-%d %H:%M:%S') }}</td>
            </tr>

            <tr>
                <td class="px-3 py-2 font-semibold text-gray-700">EDR Verdict:</td>
                <td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs font-medium {{ get_submission_status_color(submission.edr_verdict) }}"> {{ submission.edr_verdict }}</span></td>

                <td class="px-3 py-2 font-semibold text-gray-700">Project:</td>
                <td class="px-3 py-2 border-r border-gray-200">{{ submission.project or '' }}</td>

                <td class="px-3 py-2 font-semibold text-gray-700">Runtime (s):</td>
                <td class="px-3 py-2 text-gray-500">{{ submission.runtime }}</td>
            </tr>
        </tbody>
    </table>


    
    <!-- Logs Tabs -->
    {% if submission.server_logs or log or submission.edr_alerts %}
    <div class="w-full">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                {% if submission.alerts and submission.alerts|length > 0 %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600" 
                    data-tab="detonator-alerts" onclick="showTab('detonator-alerts', this)"
                >
                    Alerts
                </button>
                {% endif %}

                {% if submission.server_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="detonator-logs" onclick="showTab('detonator-logs', this)"
                >
                    Server Logs
                </button>
                {% endif %}

                {% if submission.agent_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="agent-logs" onclick="showTab('agent-logs', this)"
                >
                    Agent Logs
                </button>
                {% endif %}

                {% if submission.process_output %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="execution-logs" onclick="showTab('execution-logs', this)"
                >
                    Execution Logs
                </button>
                {% endif %}

                {% if submission.edr_alerts %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="edr-summary" onclick="showTab('edr-summary', this)"
                >
                    EDR Summary
                </button>
                {% endif %}

                {% if submission.edr_telemetry_raw %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="edr-logs" onclick="showTab('edr-logs', this)"
                >
                    EDR Raw
                </button>
                {% endif %}

                {% if submission.rededr_logs %}
                <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                    data-tab="rededr-logs" onclick="showTab('rededr-logs', this)"
                >
                    RedEdr Logs
                </button>
                {% endif %}
            </nav>
        </div>
        
        <div class="mt-4">
            {% if submission.alerts and submission.alerts|length > 0 %}
            <div id="detonator-alerts" class="tab-content">
                <div class="text-gray-700 text-sm mt-2 space-y-3">
                    <div>
                        <strong>Alerts: </strong>
                        <span class="font-semibold">{{ submission.alerts|length }}</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Source</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Title</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Severity</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Category</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Detection Source</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-700">Detected At</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                {% for alert in submission.alerts %}
                                <tr>
                                    <td class="px-3 py-2 whitespace-nowrap">{{ alert.source or 'N/A' }}</td>
                                    <td class="px-3 py-2">{{ alert.title or 'Defender alert' }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap">
                                        <span class="px-2 py-0.5 rounded {{ get_alert_severity_color(alert.severity) }}">
                                            {{ alert.severity or 'Unknown' }}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2">{{ alert.category or 'N/A' }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap">{{ alert.detection_source or 'N/A' }}</td>
                                    <td class="px-3 py-2 whitespace-nowrap">
                                        {% if alert.detected_at %}
                                        {{ alert.detected_at|strftime('%Y-%m-%d %H:%M:%S') }}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if submission.server_logs %}
            <div id="detonator-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ submission.server_logs }}</pre>
            </div>
            {% endif %}

            {% if submission.agent_logs %}
            <div id="agent-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ submission.agent_logs|pretty_json }}
                </pre>
            </div>
            {% endif %}
            
            {% if submission.process_output %}
            <div id="execution-logs" class="tab-content hidden">
                {% if submission.process_output is mapping %}
                <div class="space-y-3">
                    {% if submission.process_output.pid %}
                    <div>
                        <div class="text-xs font-semibold text-gray-600 mb-1">PID: (if available)</div>
                        <div class="bg-gray-100 p-2 rounded text-sm">{{ submission.process_output.pid }}</div>
                    </div>
                    {% endif %}
                    
                    {% if submission.process_output.stdout %}
                    <div>
                        <div class="text-xs font-semibold text-gray-600 mb-1">STDOUT: (gathered on process exit)</div>
                        <pre class="bg-gray-100 p-2 rounded text-sm max-h-60 overflow-y-auto w-full">{{ submission.process_output.stdout }}</pre>
                    </div>
                    {% endif %}
                    
                    {% if submission.process_output.stderr %}
                    <div>
                        <div class="text-xs font-semibold text-gray-600 mb-1">STDERR:</div>
                        <pre class="bg-red-50 p-2 rounded text-sm max-h-60 overflow-y-auto w-full text-red-800">{{ submission.process_output.stderr }}</pre>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ submission.process_output|pretty_json }}
                </pre>
                {% endif %}
            </div>
            {% endif %}
            
            {% if submission.edr_alerts %}
            <div id="edr-summary" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full" data-scroll-bottom
                >{{ submission.edr_alerts }}</pre>
            </div>
            {% endif %}

            {% if submission.edr_telemetry_raw %}
            <div id="edr-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full whitespace-pre-wrap" data-scroll-bottom
                    >{{ submission.edr_telemetry_raw|pretty_json }}</pre>
            </div>
            {% endif %}

            {% if submission.rededr_logs %}
            <div id="rededr-logs" class="tab-content hidden">
                <pre class="bg-gray-100 p-2 rounded text-sm max-h-80 overflow-y-auto w-full whitespace-pre-wrap" data-scroll-bottom
                    >{{ submission.rededr_logs|pretty_json }}</pre>
            </div>
            {% endif %}
    </div>
    
    <script>
        function showTab(tabId, clickedButton) {
            // Hide all tab contents
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active styles from all buttons
            const allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show target tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // Style active button
            clickedButton.classList.remove('border-transparent', 'text-gray-500');
            clickedButton.classList.add('border-blue-500', 'text-blue-600');
        }
    </script>
    {% endif %}
</div>

{% else %}
<div class="text-center text-red-500">
    <p>Error: Could not load submission details.</p>
</div>
{% endif %}
